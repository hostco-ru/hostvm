# Объединение сетевых интерфейсов

Объединение сетевых интерфейсов в единое устройство (бонд) дает следующие преимущества:

* скорость передачи данных объединенных интерфейсов выше, чем у одного;
* отказоустойчивость, поскольку отказ бонда возможен только при отказе всех входящих в него NIC.

Для поддержки одинаковых режимов и параметров объединения используйте NIC одного производителя и модели.

Режимом объединения по умолчанию является (Mode 4) Dynamic Link Aggregation. Для него требуется поддержка 802.3ad со стороны коммутатора.

Логические сети, входящие в бонд, должны быть совместимы. Среди сетей, входящих в бонд, можеть быть только одна не VLAN сеть, остальные должны иметь уникальный VLAN ID.

Объединение сетевых интерфейсов должно быть активировано со стороны портов коммутатора. Для настройки проконсультируйтесь с руководством производителя сетевого устройства.

Бонд поддерживает как VLAN-тегированный, так и нетегированный трафик. Для создания бонда используйте портал администрирования:

1. Перейдите в раздел Compute -> Hosts;
2. Выберите хост, с которого хотите перенести конфигурацию;
3. Перейдите на вкладку Network Interfaces;
4. Нажмите кнопку Setup Host Networks;
5. Проверьте конфигурацию коммутатора. Если он настроен на предоставление информации по Link Layer Discovery Protocol (LLDP), наведите курсор на физический интерфейс хоста, чтобы увидеть настройки агрегации портов коммутатора;
6. Перетащите один физический интерфейс на другой или на бонд;
7. Два физических интерфейса формируют бонд. Перетаскивание интерфейса на существующий бонд добавляет его в бонд;
8. Если логические сети несовместимы, операция по объединению будет заблокирована;
9. В окне создания бонда укажите его имя и выберите режим в полях Bond Name и Bonding Mode;
10. Нажмите OK;
11. Прикрепите логическую сеть к новому бонду и настройте ее;
12. Вы не можете прикрепить логическую сеть к отдельному интерфейсу, входящему в бонд;
13. При необходимости включите опцию Verify connectivity between Host and Engine для проверки соединения между хостом и менеджером управления. Доступна только для хостов в режиме обслуживания;
14. Нажмите OK.

Для сетей, используемых ВМ (bridged), HOSTVM поддерживает следующие режимы объединения:

1. (Mode 1) Active-Backup – активна только одна NIC, в случае отказа ее замещает резервная NIC, которая становится единственной активной в бонде;
2. (Mode 2) Load Balance (balance-xor) – выбор NIC для передачи пакетов осуществляется на основе операции XOR на MAC адресах источника и получателя, умноженных на модуль общего количества NIC. Этот алгоритм обеспечивает выбор одной и той же NIC для каждого MAC-адреса получателя.
3. (Mode 3) Broadcast – пакеты передаются всем NIC;
4. (Mode 4) Dynamic Link Aggregation(802.3ad) (по умолчанию) – NIC агрегируются в группы с одинаковыми настройками скорости и дуплекса, используются все NICs в активной группе агрегации.

Следующие режимы несовместимы с логическими сетями ВМ. К бондам, настроенным с использованием этих режимов, могут быть присоединены только сети, не используемые для трафика ВМ:

1. (Mode 0) Round-Robin – NIC для передачи пакетов выбирается последовательно, от первой до последней доступной в бонде;
2. (Mode 5) Balance-TLB, он же Transmit Load-Balance – исходящий трафик распределяется, исходя из нагрузки, по всем NIC бонда, входящий трафик принимается активной NIC. Если она отказывает, назначается другая;
3. (Mode 6) Balance-ALB, он же Adaptive Load-Balance;
4. (Mode 5) Balance-TLB совмещается с балансировкой входящего трафика IPv4. Балансировка входящей нагрузки осуществляется с помощью ARP negotiation.

Важно! Для поддержки выбранного режима объединения настройте сетевое оборудование соответствующим образом. Например, для используемого в HOSTVM режима по умолчанию IEEE 802.3ad/ LACP (mode 4) необходима соответствующая конфигурация портов коммутатора, в который подключены задействованные NIC.
