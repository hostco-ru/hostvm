# Установка Kaspersky Security для виртуальных сред 5.х

## Общие данные

Данный документ представляет собой руководство по установке пакета ПО Kaspersky Security для виртуальных сред Легкий агент в систему управления виртуализацией HOSTVM.

## Инструкция по установке

### Требования к конфигурации машины

Требования к конфигурации машины:

* процессор: 8 ядер, 2,5 ГГц, 2:2:1;
* объем ОП: 16 ГБ. 8;
* жесткий диск: 500 ГБ SATA RAID. 40;
* сетевой адаптер: 1 Гбит. 1;
* БД: Microsoft SQL Server 2008 R2 Express ([https://www.microsoft.com/ru-ru/download/details.aspx?id=30438](https://www.microsoft.com/ru-ru/download/details.aspx?id=30438)).
* Предустановленный Kaspersky Security Center

### **Установка компонентов легкого агента на KSC**

Для развертывания SVM необходимо установить компоненты Kaspersky Security для виртуальных сред Легкий агент.

Для установки компонентов необходимо:

1. Запустить файл `ksvla-components_5.1.0.405_mlg.exe;`
2. Выполнить рестарт консоли KSC;
3. После запуска мастеров настройки компонентов легкого агента выбрать все значения по умолчанию;
4. Подготовить ноду HOSTVM. Для этого в консоли ОС гипервизора выполнить команды:

```
vi /etc/libvirt/libvirtd.conf
```

Измените параметр `auth_unix_rw="sasl"` на `auth_unix_rw="none"`.

Перезапустите сервис для применения изменений командой:

```
service libvirtd restart
```

{% hint style="info" %}
Для гипервизоров версии 4.3 данный параметр расположен в конце конфигурационного файла.

Для гипервизоров версии 4.4 данный параметр расположен в блоке Authentication и закомментирован (auth\_unix\_rw = "polkit").
{% endhint %}

После изменения  режима аутентификации libvirt необходимо создать пул для хранения SVM.

### Создание пула хранения для SVM

Для создания пула хранения необходимо:

1. Создать директорию для хранилища;

```
mkdir /images
```

```
chown root:kvm /image
```

```
chmod 750 /images
```

2. Cоздать представление пула хранения данных;

```
virsh pool-define-as images dir - - - - "/images"
```

3. Создать новое хранилище на основе каталога;

```
virsh pool-build images
```

4. Запустить хранилище;

```
virsh pool-start images
```

5. Включить автозапуск для хранилища данных;

```
virsh pool-autostart images
```

6. Убедиться, что хранилище настроено правильно:

```
virsh pool-info images
```

### Настройка машины с KSC

Разархивируйте образ SVM (Package for KVM) на сервер с KSC.

Далее запустите процесс развертывания SVM c помощью консоли сервера интеграции Легкого Агента:

1. В KSC выберите Сервер администрирования -> на закладке Мониторинг в блоке Развертывание отобразится ссылка для запуска Консоли Сервера интеграции: Управление Kaspersky Security для виртуальных сред <номер версии> Легкий агент, перейдите по данной ссылке;
2. Будет запущена Консоль Сервера интеграции, в которой нужно выбрать Управление SVM и затем Развертывание SVM;
3. Добавьте новый объект виртуальной инфраструктуры с типом KVM и укажите сетевые параметры гипервизора на котором будет развернута виртуальная машина;
4. На следующем шаге выберите образ SVM, затем будет предложено выбрать имя для SVM, хранилище и имя сети.

После распаковки ВМ до ее запуска необходимо:

1. Убедиться, что для развернутой виртуальной машины выставлен владелец и группа `qemu:qemu,` в ином случае выполнить команду в консоли ОС гипервизора:

```
chown qemu:qemu /images/ksvla-svm...
```

2. Далее выполнить команды (т.к. ВМ запускается как `transient domain`), где vmname - имя, которое присваивается SVM в процессе задания параметров развертывания. Пример такого имени по умолчанию - la-svm-IP-адрес.
3. Создайте дамп конфигурационного файла виртуальной машины:

```
virsh dumpxml <vmname> > ./<vmname>.xml
```

4. Выключите виртуальную машину:

```
virsh shutdown <vmname>
```

5. Откройте дамп для редактирования:

```
vi ./<vmname>.xml
```

6. Измените параметр clock `'localtime'` на `'utc';`
7. Примените изменения командой:

```
virsh define ./<vmname>.xml
```

8. Запустите виртуальную машину:

```
virsh start <vmname>
```

9. Установите правильную таймзону:

```
timedatectl set-timezone Asia/Yekaterinburg
```

10. Внесите имя машины в DNS либо в локальный файл `/etc/hosts` на SVM (т.к. имя машины KSC должно разрешаться в IP-адрес при обращении к нему с SVM);
11. Отключите брандмауэр на машине KSC;
12. Настройте и примените политику для SVM, а также укажите в ней подключение к серверу интеграции.
