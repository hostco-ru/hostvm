# Настройка политик миграции

Миграция ВМ интенсивно нагружает сеть передачи данных, через нее менеджер виртуализации копирует на новый хост состояние памяти ВМ. В случае, когда на хосте запущено десять и более ВМ, одновременная миграция всех этих машин может занимать продолжительное время и потреблять существенное количество ресурсов. Поэтому администраторы системы должны задавать политики миграции, наиболее подходящие для конкретной инсталляции.

В процессе живой миграции менеджер виртуализации копирует состояние ВМ на новый хост в режиме реального времени. Изменения состояния, накопившиеся за время выполнения живой миграции, также должны быть переданы при ее завершении. Для передачи этих изменений на новый хост, менеджер виртуализации ставит ВМ на паузу, на доли секунды, и после завершения передачи снимает машину с паузы на новом хосте. В некоторых случаях, на высоконагруженных системах, это может занимать более продолжительное время. Политики миграции позволяют в том числе настраивать поведение системы в таких случаях.

Для настройки политик миграции кластера, с помощью портала администрирования:

1. Перейдите в раздел Compute > Clusters. Выберите кластер для настройки, нажмите кнопку Edit. В открывшемся окне перейдите на вкладку Migration Policy для просмотра текущей конфигурации политик и ее изменения;
2. В поле Migration Policy выберите требуемую политику из списка. По умолчанию используется политика Minimal downtime. Она оптимизирована для минимальной продолжительности паузы ВМ в процессе миграции. В случаях, когда эта пауза начинает занимать продолжительное время, миграция может быть прервана. Другие доступные политики:\
   • Post-copy migration - также оптимизирована на минимально возможную паузу. В случаях, когда миграция не может завершиться в течении продолжительного времени, она переводится в режим post-copy: ВМ перезапускается на целевом хосте с передачей минимально необходимых страниц памяти, остальные переносятся в процессе работы ВМ. В случае попытки доступа к странице памяти, которая еще не была перемещена, выдается page fault, и исходный хост передает эту страницу;\
   • Suspend workload if needed - позволяет ВМ мигрировать в большинстве случаев, с разной степенью нагрузки на ВМ. Продолжительность паузы ВМ может быть больше в случаях высокой нагрузки на ВМ;
3. Значение поля Bandwidth ограничивает максимальную пропускную способность хоста, для входящей и исходящей миграции, в Mbps. Доступны три варианта:\
   • Auto - значение берется из параметра Rate Limit \[Mbps] настроек Host Network QoS дата-центра. Если не указано, рассчитывается из пропускной способности интерфейса хоста;\
   • Hypervisor default - определяется службой VDSM на хосте-источнике;\
   • Custom - использует значение, заданное пользователем (в Mbps);
4. Параметр Resilience policy устанавливает политики миграции ВМ в случае отказа хоста или его перевода в режим обслуживания:\
   • Migrate Virtual Machines: мигрировать все ВМ в соответствии с их приоритетом;\
   • Migrate only Highly Available Virtual Machines: мигрировать только высокодоступные ВМ;\
   • Do Not Migrate Virtual Machines: запретить миграцию ВМ.
