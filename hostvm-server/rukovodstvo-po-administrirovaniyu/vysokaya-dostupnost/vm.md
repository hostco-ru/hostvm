# ВМ

ВМ высокой доступности автоматически перезапускается при отказе, а также в случае недоступности хоста, на котором она запущена. При наступлении этих событий, HOSTVM Manager автоматически перезапускает машину, либо на том же, либо на другом хосте кластера. HOSTVM Manager постоянно выполняет мониторинг хостов и хранилища, для обнаружения отказов оборудования. С высокой доступностью, прерывание сервиса сведено к минимуму, поскольку менеджер виртуализации перезапускает ВМ с высокой доступностью в течение нескольких секунд, без необходимости вмешательства пользователя. Настройка высокой доступности является рекомендуемой практикой для ВМ с критичными сервисами.

ВМ могут быть настроены на автоматический перезапуск в случае, если хост перестал отвечать, либо произошел отказ самой ВМ. Для использования этой опции, все хосты кластера должны поддерживать управление питанием, т.е. иметь соответствующую менеджмент плату, такую как iLO, DRAC, RSA, или подключенный по сети внешний переключатель питания, настроенные как устройство для изоляции хоста. Менеджер виртуализации может автоматически перезапускать в первую очередь машины с высоким приоритетом. Разные уровни приоритета позволяют выдавать самый высокий приоритет для самых критичных ВМ.

Настройка высокой доступности выполняется на индивидуальной основе для каждой ВМ, при ее создании либо позже, путем редактирования конфигурации машины. Настройки высокой доступности находятся на вкладке High Availability окна редактирования конфигурации ВМ.

Базовые настройки на вкладке High Availability:

* чекбокс Highly Available включает высокую доступность для ВМ;
* выпадающий список Target Storage Domain for VM Lease позволяет выбрать домен хранения для создания на нем специального раздела для ВМ (VM lease), позволяющего контролировать запуск ВМ на других хостах кластера в случае отказа текущего;
* выпадающий список Resume Behavior позволяет выбрать поведение виртуальной машины при возобновлении  работы:
  * Auto Resume: Работа виртуальной машины возобновляется автоматически, как только хранилище снова начинает работать. Это самый простой сценарий – виртуальная машина приостанавливается на время проблем с хранилищем, а затем продолжает работу без вмешательства пользователя. Такое поведение подходит для виртуальных машин с низкими требованиями к доступности и для виртуальных машин с высокой доступностью, где нежелательно использовать поведение KILL.
  * Leave Paused: Виртуальная машина не возобновляет работу автоматически. Пользователь должен вручную запустить её или выключить. Такое поведение подходит для виртуальных машин, требующих ручного вмешательства после приостановки.
  * Kill: Аналогично Auto Resume, если только виртуальная машина не была приостановлена слишком надолго. Если проблема с хранилищем устранена в течение заданного интервала времени (по умолчанию 80 секунд), работа виртуальной машины автоматически возобновляется. Но если проблема с хранилищем сохраняется в течение длительного времени,  виртуальная машина в конечном итоге будет принудительно остановлена. Такое поведение подходит для высокодоступных виртуальных машин, чтобы позволить им запускаться на другом хосте, который не имеет проблем с хранилищем.
* выпадающий список Priority позволяет указать приоритет ВМ в очереди на миграцию.

ВМ с высокой доступностью будут успешно перезапущены в случае отказа хоста при соблюдении следующих условий:

1. На хостах с запущенными ВМ с высокой доступностью настроено управление питанием (Power management);
2. Хост, на котором запущены машины, должен быть частью кластера с другими доступными хостами;
3. Целевой хост для миграции должен работать;
4. Хост-источник и целевой хост должны иметь доступ к домену хранения, на котором расположена машина;
5. Хост-источник и целевой хост должны иметь идентичный доступ к виртуальным сетям и VLAN;
6. На целевом хосте должно быть достаточно свободных ресурсов (CPU, RAM) для запуска ВМ.
