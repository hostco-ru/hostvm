# Обновление компонентов VDI

## HOSTVM VDI брокер (Переход на новую сборку в рамках версии 3.0)

### Процедура для одного сервера со встроенной БД

Обновление осуществляется путем переноса базы и настроек на новую версию ВМ брокера. В момент переноса портал и сервисы пользователей будут недоступны.

Остановить сервисы в консоли ВМ брокера VDI:

```
# systemctl stop uds apache2
```

Сделать резервную копию БД:

```
# mysqldump -u root udsdb > backup.sql
```

Скопировать бэкап на внешний ресурс.

Сохранить сетевые настройки из файла `/etc/network/interfaces` и имя машины, если их планируется переносить на новую ВМ.

Выключить ВМ.

Импортировать новую версию ВМ брокера согласно статье ["Установка HOSTVM VDI Broker"](https://kb.pvhostvm.ru/hostvm-vdi/hostvm-vdi-installation-guide/hostvm-vdi-ova-install), до момента авторизации в веб-интерфейсе управления.

Настройки сети и имя машины задать от старой версии ВМ брокера, если применимо.

После завершения базовой настройки на ВМ брокера скопировать с внешнего ресурса и развернуть резервную копию.

```
# systemctl stop uds apache2
# cat backup.sql | /usr/bin/mysql -u root udsdb
# systemctl start uds apache2
```

После запуска служб портал, конфигурация и сервисы пользователей будут доступны через веб-интерфейс брокера.

## Обновление брокера VDI на РЕД ОС

{% hint style="warning" %}
Перед обновлением убедитесь в наличии другой учетной записи с правами администратора, встроенная учётная запись администратора root будет заблокирована. После обновления измените пароль учётной записи root для её разблокирования.
{% endhint %}

Обновление проводится путём удаления пакета hostvm-vdi предыдущей версии и установки нового.

Остановить сервисы брокера VDI:

```
# systemctl stop vdi.service vdiweb.service
```

Удалить пакет hostvm-vdi:

```
# rpm -e hostvm-vdi
```

Удалить следующие сертификаты:

```
/etc/certs/dhparam.pem
/etc/certs/key.pem
/etc/certs/server.pem
```

Удалить символическую ссылку `/etc/nginx/sites-enabled`:

```
# rm /etc/nginx/sites-enabled
```

Из файла `/etc/nginx/nginx.conf` удалить следующие строки:

```
include /etc/nginx/sites-enabled;
ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
ssl_prefer_server_ciphers on;
gzip on;
```

Произвести пакетную установку брокера VDI согласно [инструкции для РЕД ОС](hostvm-vdi-ova-install/paketnaya-ustanovka-brokera-dlya-red-os.md)

В случае, если используется внешняя БД, отредактируйте файл настроек брокера `/var/server/server/settings.py`  и в блок `DATABASES`внесите информацию о сервере БД:

<pre><code><strong>DATABASES = {
</strong>    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'OPTIONS': {
            'isolation_level': 'read committed',
        },
        'NAME': 'udsdb',                     # имя БД, по умолчанию udsdb
        'USER': 'udsdbadm',                  # имя пользователя БД, по умолчанию udsdbadm
        'PASSWORD': 'password',              # пароль пользователя БД, как был задан в мастере установки сервера БД
        'HOST': '10.1.1.1',                  # IP адрес сервера БД, например 10.1.1.1
        'PORT': '',                          # порт сервера БД, оставьте пустым при использовании порта по умолчанию
    }
}
</code></pre>

Перезапустите службы брокера VDI:

```shell-session
# systemctl restart vdi.service vdiweb.service
```

## HOSTVM VDI туннелер

### Процедура для одного сервера

Обновление осуществляется путем разворачивания новой версии туннелера и подключения к VDI брокеру согласно статье ["Установка HOSTVM VDI Tunneler"](https://kb.pvhostvm.ru/hostvm-vdi/hostvm-vdi-installation-guide/tunneler-appliance-deploy).

При задании сетевых настроек, идентичных старой версии туннелера, дополнительной конфигурации со стороны брокера не требуется.

Если будет использоваться другой IP адрес, необходимо создать соответствующие транспорты для туннельных подключений в панели управления брокера, с использованием нового адреса.
