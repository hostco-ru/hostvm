# Установка Tunneler appliance

## Развертывание Tunneler версии 2.2

### Требования к конфигурации виртуальной машины

Минимальные требования к ресурсам:

* Hard drive: 10 GB
* Memory: 1 G
* CPU: 2 vCPU
* Network: 1 vNIC

### Импорт виртуальной машины

Скачать образ машины UDS-Tuneler-2.2.zip из каталога загрузок HOSTVM.&#x20;

Загрузить данный файл на один из хостов виртуализации к HOSTVM с помощью scp или других средств.&#x20;

Распаковывать и подготовить к импорту, загрузить в export домен платформы виртуализации:

```bash
unzip UDS-Tuneler-2.2.zip
mv UDS-Tuneler-2.2 UDS-Tuneler-2.2.qcow2
qemu-img convert ./UDS-Tuneler-2.2.qcow2 -O raw ./UDS-Tuneler-2.2.raw
export LIBGUESTFS_BACKEND=direct
virt-v2v -i disk /home/UDS-Tuneler-2.2.raw -o rhv -os /export/domain/mount/point
```

Точку монтирования домена можно посмотреть через веб-интерфейс платформы виртуализации:

&#x20;`GUI>Storage>Domains>выбрать export домен>Manage domain>путь будет указан в поле Path`

Импортировать через `GUI>compute>virtual machines>import`, в качестве источника выбрать export domain. При импорте необходимо добавить сеть (перейти на вкладку **Network Interfaces** и указать нужную сеть для данной ВМ).

### Настройка

Для настройки нужно подключиться к ВМ через spice консоль: `GUI>compute>virtual machines>выбрать машину>нажать кнопку Console`

Первый запуск конфигуратора нужно отменить, затем добавить сертификат машины HOSTVM VDI в доверенные, иначе настройка завершится ошибкой.

```bash
cp cert-bundle.crt /usr/local/share/ca-certificates/
update-ca-certificates
```

После настройки сертификатов запустить конфигуратор повторно командой `SetupTunneler.sh`

Дальнейший процесс установки проходит в графическом режиме, необходимо указать следующие параметры:

```
Network configuration:
hostname: имя машины туннелера
domain: домен машины
ip: IP-адрес
mask: маска сети
gateway: шлюз
primary dns: IP-адрес сервера DNS
secondary dns: IP-адрес сервера DNS

Broker configuration:
broker server url: ссылка на веб-интерфейс машины HOSTVM VDI, например https://vdi.domain.ru
```

### Настройка транспорта Spice tunnel в панели управления HOSTVM VDI

При настройке транспорта Spice tunnel в панели управления HOSTVM VDI, в качестве tunnel server указывается `имя_машины_туннелера:443`

## Развертывание Tunneler версии 3.0

### Требования к конфигурации виртуальной машины

* Hard drive: 10 GB
* Memory: 2 G
* CPU: 2 vCPU
* Network: 1 vNIC

### Импорт виртуальной машины

Скачать образ машины UDS-Tunnel-qcow2.3.0.0.zip из каталога загрузок HOSTVM.&#x20;

Загрузить данный файл на один из хостов виртуализации к HOSTVM с помощью scp или других средств.&#x20;

Распаковывать и подготовить к импорту, загрузить в export домен платформы виртуализации:

```bash
unzip UDS-Tunnel-qcow2.3.0.0.zip
qemu-img convert ./UDS-Tunnel-qcow2.3.0.0 -O raw ./UDS-Tuneler-3.0.raw
export LIBGUESTFS_BACKEND=direct
virt-v2v -i disk /home/UDS-Tuneler-3.0.raw -o rhv -os /export/domain/mount/point
```

Точку монтирования домена можно посмотреть через веб-интерфейс платформы виртуализации:

&#x20;`GUI>Storage>Domains>выбрать export домен>Manage domain>путь будет указан в поле Path`

Импортировать через `GUI>compute>virtual machines>import`, в качестве источника выбрать export domain. При импорте необходимо добавить сеть (перейти на вкладку **Network Interfaces** и указать нужную сеть для данной ВМ).

### Настройка

Для настройки нужно подключиться к ВМ через spice консоль: `GUI>compute>virtual machines>выбрать машину>нажать кнопку Console`

После подключения отредактировать раскладку в `/etc/default/keyboard`:

```
    XKBLAYOUT="us"
```

Применить изменения командой:

`setupcon`

Настроить сеть, если нет dhcp (без сети конфигуратор не запустится). Пример настройки:

`/etc/network/interfaces`

```
    allow-hotplug eth0
    iface eth0 inet static
    address 10.1.1.2
    netmask 255.255.255.0
    gateway 10.1.1.1
```

Указать адреса DNS в `/etc/resolv.conf`

Перезапустить интерфейс для применения настроек.

```bash
ifdown eth0
ifup eth0
```

Перед запуском конфигуратора нужно установить сертификат машины HOSTVM VDI в доверенные, иначе настройка завершится ошибкой.

```bash
cp cert-bundle.crt /usr/local/share/ca-certificates/
update-ca-certificates
```

Дальнейшая настройка производится через браузер по адресу: `http://<tunneler_ip>:9900`

После открытия веб-страницы конфигуратора выполните следующие действия:

1. Выберите язык установки.
2. Проверьте параметры: имя сервера, домен, настройки сети и dns.\
   Если параметры сети не требуют корректировки, выберите в выпадающем списке опцию “Skip network config (leave it as is)”.\
   Если корректировка требуется, оставьте в выпадающем списке опцию "Configure network" и внесите изменения. В случае смены ip адреса установщик автоматически перенаправит пользователя на новый, для продолжения установки.
3. Проверьте и подтвердите настройки, дождитесь их применения.
4. Настройте раскладку клавиатуры, часовой пояс и ntp сервер (необязательно).
5. Задайте пароль локального пользователя root для сервера туннелирования.
6. Задайте настройки подключения к vdi брокеру, указав его fqdn или ip. Использование подключения "HTTPS (Secure Connection)” возможно в случае наличия действительного сертификата на брокере, иначе используйте подключение “HTTP”.
7. Загрузите https сертификаты для сервера туннелирования (необязательно), либо пропустите шаг, нажав next.
8. Завершите настройку перезагрузкой сервера, и закройте страницу установщика. После перезагрузки сервер будет готов к работе.

При необходимости запустить конфигуратор заново, авторизуйтесь на сервере под пользователем root и паролем, указанным в шаге 5, затем запустите команду:

```bash
uds setup
```

После выполнения команды конфигуратор будет доступен через браузер по адресу: `http://<tunneler_ip>:9900`.

### Настройка транспорта Spice tunnel в панели управления HOSTVM VDI

При настройке транспорта Spice tunnel в панели управления HOSTVM VDI, в качестве tunnel server указывается `имя_машины_туннелера:443`
