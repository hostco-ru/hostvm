---
layout:
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: true
---

# Установка HOSTVM VDI Tunneler

## Версия 3.5 и выше <a href="#id-3.5" id="id-3.5"></a>

### Импорт виртуальной машины

* Скачайте образ машины `HOSTVM-VDI/Stable/3.5/hostvm-gw35-<номер сборки>.tar.bz2` из каталога загрузок HOSTVM.
* Загрузите данный файл на один из хостов виртуализации HOSTVM с помощью scp или других средств.
* Распакуйте командой: `tar xjvf hostvm-gw35-<номер сборки>.tar.bz2`
* Откройте портал администрирования платформы виртуализации HOSTVM, перейдите в раздел **Compute - Virtual Machines.**
* Нажмите на иконку из трех вертикальных точек в правом верхнем углу интерфейса и выберите пункт **Import.**
* Выберите в качестве источника импорта **Source** файл OVA: "**Virtual Appliance(OVA)**". Укажите хост, на котором расположен файл ВМ и абсолютный путь директории с файлом, нажмите кнопку Load для поиска образа.
* Выберите нужный образ в результатах поиска, переместите его с помощью стрелки в список ВМ для импорта (справа) и нажмите кнопку **Next.**
* В появившемся окне задайте домен хранения и кластер для ВМ. Выделите ВМ в списке, перейдите на вкладку **Network Interfaces** и задайте логическую сеть для данной ВМ.
* После этого с помощью кнопки **OK** запустите импорт OVA и дождитесь его окончания.
* Запустите полученную ВМ, подключитесь к ней с помощью консоли. Авторизуйтесь с логином/паролем _root/engine._
* Задайте новый пароль для учетной записи root с помощью команды `passwd`

### Настройка сети

В случае получения IP адрес по DHCP данный раздел настройки можно пропустить.

Если требуется настройка статического адреса, подключитесь к ВМ через консоль: `Compute > Virtual machines > выбрать машину > нажать кнопку Console`

После подключения внесите изменения в файл `/etc/network/interfaces`, задав параметры IP адреса, маски сети, и шлюза по умолчанию.

Пример настройки:

```
allow-hotplug eth0
iface eth0 inet static
    address 10.1.1.3
    netmask 24
    gateway 10.1.1.1
```

Укажите адреса DNS в `/etc/resolv.conf`

Перезапустите виртуальную машину для применения настроек:

```bash
reboot
```

При необходимости, задайте новое имя ВМ командой `hostnamectl set-hostname <имя_машины>`.

### Настройка сертификатов <a href="#ssl-certificates-35" id="ssl-certificates-35"></a>

Для подключения к брокеру HOSTVM VDI по протоколу HTTPS требуется наличие установленного действительного сертификата на ВМ брокера. При необходимости, перед запуском мастера установки добавьте CA сертификат в доверенные.

Для этого скопируйте его на машину HOSTVM VDI туннелера и поместите в директорию `/usr/local/share/ca-certificates`.

Пример:

```shell-session
root@hostvm-gw:~# cp ca-cert-bundle.crt /usr/local/share/ca-certificates/
```

Затем выполните команду:

```shell-session
root@hostvm-gw:~# update-ca-certificates
```

#### Сертификат для HTML5 подключений <a href="#html5-certificate" id="html5-certificate"></a>

По умолчанию при HTML5 подключениях используется предустановленный самоподписанный сертификат, для его замены воспользуйтесь данной инструкцией.

Скопируйте файлы сертификата на туннелер HOSTVM VDI в директорию `/etc/certs`.

Отредактируйте конфигурационный файл `/etc/tomcat9/server.xml`, в значения параметров `SSLCertificateFile` и `SSLCertificateKeyFile` запишите путь к открытой части сертификата и приватному ключу соответственно:

```xml
<Connector port="10443" protocol="org.apache.coyote.http11.Http11AprProtocol" SSLEnabled="true"
                   ...
                   SSLCertificateFile="/etc/certs/server.pem"
                   SSLCertificateKeyFile="/etc/certs/key.pem"
                   ... />
```

Для применения изменений выполните команду:

```shell-session
root@hostvm-gw:~# systemctl restart tomcat9
```

### Мастер установки HOSTVM VDI Tunneler <a href="#setup-wizard" id="setup-wizard"></a>

Выполните команду `hostvm-setup` для запуски мастера установки.

Задайте запрашиваемые мастером параметры конфигурации:

* IP адрес развернутого брокера HOSTVM VDI
* Тип соединения с брокером (http или https)
* Учетная запись с правами администратора на брокере (аутентификатор, логин, пароль). Для использования встроенной учетной записи администратора оставьте значение аутентификатора пустым, нажав Enter (как в примере ниже).

**Пример конфигурации:**

```shell-session
root@hostvm-gw35:~# hostvm-setup 
Добро пожаловать в мастер установки HOSTVM VDI Tunneler.
Этот мастер шаг за шагом проведет вас через процесс установки.
Пожалуйста, заполните все поля корректными значениями.
IP адрес или FQDN брокера: 10.1.1.2
Тип соединения с брокером (http или https): http
На брокере доступны следующие аутентификаторы:
int
Укажите аутентификатор из списка доступных, либо оставьте пустым, 
если используете встроенную учетную запись администратора: 
Имя пользователя: root
Пароль: 
Конфигурация системы...
Установка завершена.
root@hostvm-gw35:~# 
```

### Настройка транспорта в панели управления HOSTVM VDI

При настройке туннелированных подключений (транспортов) в панели управления брокера HOSTVM VDI, в качестве параметра tunnel server на вкладке Tunnel настроек транспорта указывайте адрес настроенной ВМ туннелера в формате `адрес:порт`, где адрес - IP или FQDN туннелера, порт - порт подключения, по умолчанию 443.

![](../../.gitbook/assets/tunneler30-8.png)

### Портал пользователя <a href="#user-portal" id="user-portal"></a>

> Данный функционал доступен начиная с версии 3.6

По умолчанию при запуске новой виртуальной машины HOSTVM VDI Tunneler портал пользователя не доступен.

Для активации портала запустите мастер настройки, выполнив команду `hostvm-vdi-gui-setup`

Задайте запрашиваемые мастером параметры конфигурации:

* IP адрес или FQDN брокера HOSTVM VDI

**Пример конфигурации:**

{% code overflow="wrap" %}
```shell-session
root@hostvm-gw36:~# hostvm-vdi-gui-setup 
** Добро пожаловать в мастер настройки HOSTVM VDI Broker Web UI. Пожалуйста, заполните все поля корректными значениями. Для принятия значений по умолчанию нажимайте ENTER.

** Введите IP адрес или FQDN брокера HOSTVM VDI []: hostvm-vdi36
** Перезаписать конфигурацию? [Y/n]: y
** Конфигурация обновлена, задан адрес брокера: hostvm-vdi36
** Настройка завершена.
```
{% endcode %}

После завершения настройки портал будет доступен по адресу `https://<IP или FQDN туннелера>:1443/`

Для настройки SSL сертификатов портала воспользуйтесь соответствующим разделом руководства по установке брокера HOSTVM VDI:

[Настройка SSL сертификатов](hostvm-vdi-ova-install/#ssl-certificates)

## Версия 3.0 <a href="#id-3.0" id="id-3.0"></a>

### Импорт виртуальной машины

* Скачайте образ машины `HOSTVM-VDI/Stable/3.0/hostvm-tunneler-<номер сборки>.tar.bz2` из каталога загрузок HOSTVM.
* Загрузите данный файл на один из хостов виртуализации HOSTVM с помощью scp или других средств.
* Распакуйте командой: `tar xjvf hostvm-tunneler-<номер сборки>.tar.bz2`
* Откройте портал администрирования платформы виртуализации HOSTVM, перейдите в раздел **Compute - Virtual Machines.**
* Нажмите на иконку из трех вертикальных точек в правом верхнем углу интерфейса и выберите пункт **Import.**
* Выберите в качестве источника импорта **Source** файл OVA: "**Virtual Appliance(OVA)**". Укажите хост, на котором расположен файл ВМ и абсолютный путь директории с файлом, нажмите кнопку Load для поиска образа.
* Выберите нужный образ в результатах поиска, переместите его с помощью стрелки в список ВМ для импорта (справа) и нажмите кнопку **Next.**
* В появившемся окне задайте домен хранения и кластер для ВМ. Выделите ВМ в списке, перейдите на вкладку **Network Interfaces** и задайте логическую сеть для данной ВМ.
* После этого с помощью кнопки **OK** запустите импорт OVA и дождитесь его окончания.
* Запустите полученную ВМ.

### Настройка сети

В случае получения IP адрес по DHCP данный раздел настройки можно пропустить.

Если требуется настройка статического адреса, подключитесь к ВМ через консоль: `Compute > Virtual machines > выбрать машину > нажать кнопку Console`

После подключения внесите изменения в файл `/etc/network/interfaces`, задав параметры IP адреса, маски сети, и шлюза по умолчанию.

Пример настройки:

```
allow-hotplug eth0
iface eth0 inet static
    address 10.1.1.3
    netmask 24
    gateway 10.1.1.1
```

Укажите адреса DNS в `/etc/resolv.conf`

Перезапустите виртуальную машину для применения настроек:

```bash
reboot
```

### Настройка сертификатов <a href="#ssl-certificates-30" id="ssl-certificates-30"></a>

Для подключения к брокеру HOSTVM VDI по протоколу HTTPS требуется наличие установленного действительного сертификата на ВМ брокера. При необходимости, перед запуском графического мастера установки добавьте CA сертификат в доверенные.

Для этого скопируйте его на машину HOSTVM VDI туннелера и поместите в директорию `/usr/local/share/ca-certificates`.

Пример:

```shell-session
root@hostvm-gw:~# cp ca-cert-bundle.crt /usr/local/share/ca-certificates/
```

Затем выполните команду:

```shell-session
root@hostvm-gw:~# update-ca-certificates
```

#### Сертификат для HTML5 подключений

По умолчанию при HTML5 подключениях используется предустановленный самоподписанный сертификат, для его замены воспользуйтесь данной инструкцией.

Скопируйте файлы сертификата на туннелер HOSTVM VDI в директорию `/etc/certs`.

Отредактируйте конфигурационный файл `/etc/tomcat9/server.xml`, в значения параметров `SSLCertificateFile` и `SSLCertificateKeyFile` запишите путь к открытой части сертификата и приватному ключу соответственно:

```xml
<Connector port="10443" protocol="org.apache.coyote.http11.Http11AprProtocol" SSLEnabled="true"
                   ...
                   SSLCertificateFile="/etc/certs/server.pem"
                   SSLCertificateKeyFile="/etc/certs/key.pem"
                   ... />
```

Для применения изменений выполните команду:

```shell-session
root@hostvm-gw:~# systemctl restart tomcat9
```

### Мастер установки HOSTVM VDI Tunneler

После настройки параметров сети и перезапуска машины, мастер установки будет доступен через браузер по адресу: `http://<ip_адрес_ВМ_туннелера>:9900`

<figure><img src="../../.gitbook/assets/tunneler30-1.png" alt=""><figcaption></figcaption></figure>

После открытия веб-страницы конфигуратора выполните следующие действия:

* Выберите язык установки.
* Проверьте параметры: имя сервера, домен, настройки сети и dns.\
  Если параметры сети не требуют корректировки, выберите в выпадающем списке опцию “Skip network config (leave it as is)”.\
  Если корректировка требуется, оставьте в выпадающем списке опцию "Configure network" и внесите изменения. В случае смены ip адреса установщик автоматически перенаправит пользователя на новый, для продолжения установки.

<figure><img src="../../.gitbook/assets/tunneler30-2.png" alt=""><figcaption></figcaption></figure>

* Проверьте и подтвердите настройки, дождитесь их применения.
* Настройте раскладку клавиатуры для ОС, часовой пояс и ntp сервер (необязательно).

<figure><img src="../../.gitbook/assets/tunneler30-3.png" alt=""><figcaption></figcaption></figure>

* Задайте пароль локального пользователя root для ОС сервера туннелирования.

<figure><img src="../../.gitbook/assets/tunneler30-4.png" alt=""><figcaption></figcaption></figure>

* Задайте настройки подключения к vdi брокеру, указав его fqdn или ip. Использование подключения "HTTPS (Secure Connection)” возможно в случае наличия действительного сертификата на брокере, иначе используйте подключение “HTTP”.

<figure><img src="../../.gitbook/assets/tunneler30-5.png" alt=""><figcaption></figcaption></figure>

* Загрузите https сертификаты для сервера туннелирования (необязательно), либо пропустите шаг, нажав next.

<figure><img src="../../.gitbook/assets/tunneler30-6.png" alt=""><figcaption></figcaption></figure>

* Завершите настройку перезагрузкой сервера, и закройте страницу установщика. После перезагрузки сервер будет готов к работе.

<figure><img src="../../.gitbook/assets/tunneler30-7.png" alt=""><figcaption></figcaption></figure>

При необходимости запустить конфигуратор заново, авторизуйтесь на сервере под пользователем root и паролем, указанным в шаге 5, затем запустите команду:

```bash
uds setup
```

После выполнения команды конфигуратор будет доступен через браузер по адресу: `http://<ip_адрес_ВМ_туннелера>:9900`.

### Настройка транспорта в панели управления HOSTVM VDI

При настройке туннелированных подключений (транспортов) в панели управления брокера HOSTVM VDI, в качестве параметра tunnel server на вкладке Tunnel настроек транспорта указывайте адрес настроенной ВМ туннелера в формате `адрес:порт`, где адрес - IP или FQDN туннелера, порт - порт подключения, по умолчанию 443.

<figure><img src="../../.gitbook/assets/tunneler30-8.png" alt=""><figcaption></figcaption></figure>

