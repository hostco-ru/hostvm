# Обновление конфигурации из двух экземпляров брокера VDI со встроенной БД (с репликацией).

1. **Подготовка к обновлению:**

**На мастер-сервере:**

1.1. Проверьте имя используемой базы данных в настройках брокера:

```
# cat /var/server/server/settings.py | grep "'NAME'"
```

Пример вывода:

```
'NAME': 'udsdb', # Or path to database file if using sqlite3.
```

где **udsdb** – имя базы данных брокера.

1.2.  Создайте резервную копию БД, выполнив команду:

```
# mysqldump -u root --single-transaction udsdb > backup.sql
```

где **udsdb** – имя базы данных брокера,

**backup.sql** – имя файла резервной копии.

1.3.  Скопируйте файл резервной копии на внешний ресурс.

1.4.  Сохраните сетевые настройки из файла `/etc/network/interfaces` и имя машины, если их планируется переносить на новую ВМ.



После завершения выключите обе ВМ брокеров VDI.

**2. Развертывание новых версий брокера:**

2.1  Выполните процедуру импорта новой версии ВМ брокера согласно статье ["Установка HOSTVM VDI Broker"](https://kb.pvhostvm.ru/hostvm-vdi/hostvm-vdi-installation-guide/hostvm-vdi-ova-install), до момента авторизации в веб-интерфейсе управления (в двух экземплярах).

2.2  Задайте настройки сети и имена машин от старых версий ВМ брокера, если применимо.

2.3  После завершения базовой настройки на ВМ первого брокера (мастер сервер БД) скопируйте с внешнего ресурса и разверните резервную копию:

```
# systemctl stop uds apache2
# cat backup.sql | /usr/bin/mysql -u root udsdb
# systemctl start uds apache2
```

где **udsdb** – имя базы данных брокера,

**backup.sql** – имя файла резервной копии.

**3. Настройка репликации:**

3.1  Выполните процедуру настройки репликации базы данных между двумя серверами согласно статье: [https://kb.pvhostvm.ru/hostvm-vdi/hostvm-vdi-admin-guide/vdi-db-replication](https://kb.pvhostvm.ru/hostvm-vdi/hostvm-vdi-admin-guide/vdi-db-replication)
